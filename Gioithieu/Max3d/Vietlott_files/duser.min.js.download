var izichat,anysocket,utils,management,communicate,userInterface,req,sound,template,timer,localdata,backgroundnotif,__connector={send:function(){}},izilog=function(){};const widgetURL=new URL(window.location.href);window.runIziChat=function(){function a(a){try{var b="string"==typeof a.data?JSON.parse(a.data):a.data;if(izilog("[handleEvents]",a),"event:init-sdk"===b.topic)localdata.val("parentLocation",b.location),localdata.val("parentDocument",b.document),b.authToken&&req.setAuthToken(b.authToken),__iziconfig.isDebug(new URL(b.location.href).searchParams.get("debug")||"")&&(izilog=console.log),izilog("[iframe] chat loading..."),management.initChat();else if(localdata.config){var c=localdata.config.form.connector,d=localdata.config.profile,e=a.origin.replace(/^(https?:\/\/)?(www\.)?|:[0-9]+$/gi,""),f=d.host.replace(/^(https?:\/\/)?(www\.)?|:[0-9]+$/gi,"");if(e!==f)return void izilog("[handleEvents] profile host",f,"not equal",e);if(!c.enable)return void izilog("[handleEvents] connector disabled");if(c.trusted_host&&a.origin!==c.trusted_host)return void izilog("[handleEvents] trusted_host invalid",a.origin,c.trusted_host);management.execCommands(b)}}catch(a){izilog("[handleEvents] error",a)}}if(__iziconfig.isDebug()&&(izilog=console.log),console.log("IZIChat Initializing..."),wc=screen.width,wcsDevice=640,localdata=new _LocalData,utils=new _Util({localdata}),req=new _Request,template=new _Template("tpl_"),management=new _Management,userInterface=new _Interface,communicate=new _TabCommunicate,emoji=new _Emoji,timer=new _Timer,sound=new _Sound,backgroundnotif=new _FireBaseNotif,window.chatUtils=utils,__connector={send(a,b,c){window.parent.postMessage(JSON.stringify({topic:a,data:b}),c||widgetURL.searchParams.get("origin")||window.location.origin)}},window.addEventListener?window.addEventListener("message",a,!1):window.attachEvent&&window.attachEvent("onmessage",a),window.parent!=window){localdata.val("isInFrame",!0);try{__connector.send("event:init-sdk")}catch(a){izilog("[iframe] postMessage",a)}}else localdata.val("parentLocation",window.location),localdata.val("parentDocument",window.document),management.initChat()};var _Management=function(){function a(a,...b){if(a){if(izilog("taskResult",a,...b),!localdata.trans)return console.trace("taskResult",a),void console.log("Could not load translate",a,...b);var c,d="";if("string"==typeof a)try{c=JSON.parse(a).errors}catch(b){c=a}c&&c.single?d=localdata.trans.errors[c.single]||c.single:c&&(d=localdata.trans.errors[c]||c),d&&(userInterface.displayErrorNotify(d),console.log(d))}}function b(){var b=!1!==localdata.localSetting("sound-received");localdata.localSetting("sound-received",b);var d=localdata.localSetting("badge-log"),e=Date.now();(!d||864e5<e-d)&&localdata.val("isRunBadged",!0),req.getWidgetVersion(function(a,b){if(a)return void izilog(a);var c=localdata.localSetting("_w_v");c&&c!==b&&(localdata.localSetting("_w_v",b),window.location.reload(!0))}),req.getSetting(function(b,d){return b?a(b):void(localdata.val("config",d),req.getTranslation(d,function(b,e){return b?a(b):(localdata.val("trans",e.translation),template.translation(e.translation),window.isEmptyObject(d)?a("chat.setting.not_found"):void(localdata.config.profile.enable?c():a()))}))})}function c(){var a=localdata.config.enums.Schedule,b=localdata.config.is_business_hour,c=localdata.config.widget.schedule;(a.BusinessHours!=c||b)&&(userInterface.applyConfig(localdata.config),userInterface.setComponentColor(),userInterface.localConfig(),d(),f())}function d(){var a=localdata.config.form.connector.trusted_host||"*";window.parent.postMessage("{\"topic\":\"initialized\"}",a),__connector.send("event:initialized",{success:!0},a)}function e(){return localdata.isRunBadged?void userInterface.initBanner(function(){function a(a){userInterface.displayBanner(!1),userInterface.displayMainChat(!0),userInterface.maximize(!0),localdata.localSetting("badge-log",Date.now()),a(),j()}userInterface.btnHeaderBannerClick(),userInterface.btnBannerSendMessage(a),userInterface.btnContentBannerClick(a)}):(userInterface.displayBanner(!1),void userInterface.displayMainChat(!0))}function f(b){return b?a(b):void K.login(null,function(b){if(b)return a(b);if(localdata.user&&!localdata.user.is_requester)return g();var c=localdata.config.enums.Schedule,d=localdata.config.is_business_hour,f=localdata.config.widget.schedule;return localdata.user||c.BusinessHours!=f||d?void(e(),h()):a()})}function g(){document.body.style.display="",userInterface.displayBanner(!1),userInterface.displayMainChat(!0),userInterface.btnMinimizeClick(),userInterface.btnMaximizeClick(function(a){a()}),userInterface.initAgentInterface()}function h(){document.body.style.display="",localdata.user&&(__connector.send("event:login",{success:!0}),k()),userInterface.btnSoundReceivedChange(),userInterface.btnMinimizeClick(),userInterface.btnMaximizeClick(function(a){return localdata.user||"left-chat"==localdata.widgetStatus?a():void(a(),j())}),localdata.user||i()}function i(){var a=localdata.config;!a.form.pre_chat.active_chat||anysocket&&anysocket.isConnected()||(anysocket=new IZIAnonymousSocket(localdata.config.host,a.setting.ed_user_id,{izilog,localdata},function(){anysocket.pushListener("onAgentStartChat",function(a){localdata.session||(localdata.val("agentStartId",a._id),K.addAnonymousAccount(!0,k),userInterface.displayBanner(!1),userInterface.displayMainChat(!0),userInterface.alreadyInitPreChat(!0),userInterface.maximize(!0))})}))}function j(){if(!userInterface.alreadyInitPreChat()){req.getGeoIP(function(){izilog("GEO Initialized...")});var a=localdata.config.form;a.pre_chat.enable?(userInterface.initPreChat(function(){K.addAnonymousAccount(!1,k)}),userInterface.btnStartChatClick(function(){K.addAnonymousAccount(!1,k)})):K.addAnonymousAccount(!1,k),userInterface.alreadyInitPreChat(!0)}}function k(b){return b?a(b):void(l(),x(function(b,c){return b?a("session.create_failure"):void(localdata.val("session",c.session),c.session.counting.unread.agent&&userInterface.unreadCounter(c.session.counting.unread.agent.unread),m())}))}function l(){backgroundnotif.init({location:localdata.parentLocation})}function m(){userInterface.initInChat(),n()}function n(){return localdata.session.is_create_new?o():void(req.loadMessages(localdata.session._id,function(b,c){return b?a(b):void(userInterface.displayMessages(c,!0),userInterface.scrollChatArea(null,!0),o())}),v(localdata.session._id))}function o(){z(function(){p()})}function p(){function b(b){function c(){!(b||"").trim()||100>timer.diffNow("send-message")&&0<=timer.diffNow("send-message")||(timer.set("send-message"),izichat.sendMessage(t(b),function(b,c){return b?a(b):void(userInterface.clearMsgInput(),userInterface.scrollChatArea(function(){userInterface.displayMessages([c])},!0),communicate.send("send-message",c))}))}u(),localdata.session?c():y(c)}izilog("[taskInitOnlineChatEvents] already init",userInterface.alreadyInitOnlineChat());userInterface.alreadyInitOnlineChat()||(userInterface.pressEnterMsgInput(b),userInterface.clickBtnSendMessage(b),userInterface.onSelectedAttach(function(b){function c(){var c=localdata.session;req.addMessage(c._id,b,function(b,c){return b?a(b):void(userInterface.scrollChatArea(function(){userInterface.displayMessages([c.message])}),communicate.send("send-message",c.message))})}return u(),3145728<b.size?void userInterface.scrollChatArea(function(){userInterface.displayErrorNotify(localdata.trans.errors.file_too_large)}):void(localdata.session?c():y(c))}),userInterface.pressAnyMsgInput(function(a){if(u(),a){if(1500>timer.diffNow("replying")&&0<=timer.diffNow("replying"))return;timer.set("replying"),izichat.replying(!0)}}),userInterface.btnLeavePopupClick(),userInterface.btnLeaveClick(function(a,b){var c=localdata.session;return c?void req.rateChat(c._id,a,function(){b()}):b()}),userInterface.mainContainerClick(u),userInterface.btnRatingChooseClick(),userInterface.btnEmojiClick(),userInterface.btnMoreMessagesClick(w),communicate.addListener("send-message",function(a){userInterface.scrollChatArea(function(){userInterface.displayMessages([a.message])})}),userInterface.alreadyInitOnlineChat(!0),izilog("[taskInitOnlineChatEvents] done"),a())}function q(a){return a.replace(/</g,"&lt").replace(/>/,"&gt")}function r(a){var b={},c=utils.getUrls(a);for(var d in(c||[]).forEach(function(c){if(c){var d="_["+Math.random()+"]_",e=c;a=a.replace(c,d),-1==c.search("http")&&(e="http://"+e),b[d]=template.fillTemplate("alink_tag",{URL:e,TEXT:c},{IS_NEW_TAB:!0})}}),b)a=a.replace(d,b[d]);return a}function s(a){return(a||"").replace(/\n+/g,"<br>")}function t(a){return emoji.toHtml(r(s(q(a))))}function u(){localdata.session&&localdata.isMaximize&&localdata.val("total-unread")&&(userInterface.clearUnread(),req.markAllRead(localdata.session._id,function(){}))}function v(b){userInterface.displayBtnLoadmoreMessages(!1),req.loadRecentSession(b,function(b,c){return b?a(b):void(!c.session_id||(localdata.val("recentSessionId",c.session_id),userInterface.displayBtnLoadmoreMessages(!0)))})}function w(){var b=localdata.recentSessionId;b&&req.loadMessages(b,function(c,d){return c?a(c):void(userInterface.displayRecentMessages(d,b),v(b))})}function x(a){var b=J();req.getChatSession({routing:b,ref:(localdata.session||{})._id,agent_start_id:localdata.agentStartId},a)}function y(b){x(function(c,d){return c?a("session.create_failure"):void(localdata.val("session",d.session),izichat.updateSession(d.session),z(function(){b()}))})}function z(b){return anysocket&&anysocket.socket.disconnect(),izichat&&izichat.isConnected()?b():void(izichat=new IZIRequesterSocket(localdata.config.host,localdata.session,{izilog,localdata},function(){izichat.pushListener("onAgentOffline",function(){izilog("agent offline")}),izichat.pushListener("onAgentOnline",function(){izilog("agent online")}),izichat.pushListener("onAgentHandle",C),izichat.pushListener("onAgentBlock",D),izichat.pushListener("onAgentReplying",G),izichat.pushListener("onAgentMessage",A),izichat.pushListener("onTriggerMessage",B),izichat.pushListener("onAgentLeft",E),izichat.pushListener("onAgentClosed",F),izichat.pushListener("onReconnected",H),(localdata.preAskMessage||"").trim()&&izichat.sendMessage(t(localdata.preAskMessage),function(b,c){return b?a(b):void(userInterface.clearMsgInput(),userInterface.scrollChatArea(function(){userInterface.displayMessages([c])},!0),communicate.send("send-message",c))}),b()}))}function A(a,b){userInterface.scrollChatArea(function(){sound.onMessage(),userInterface.displayMessages([b.message]),userInterface.unreadCounter(1,!0),utils.find(".izi-chat-typing").hide()})}function B(a,b){userInterface.scrollChatArea(function(){sound.onMessage(),userInterface.displayMessages([b.message]),userInterface.unreadCounter(1,!0)})}function C(b,c){x(function(b,d){return b?a("session.create_failure"):void(localdata.val("session",d.session),izichat.updateSession(d.session),c.doMaximize&&userInterface.maximize(!0))})}function D(){userInterface.scrollChatArea(function(){userInterface.displayErrorNotify(localdata.trans.blocked)}),localdata.clear(),userInterface.disableMsgInput()}function E(){izilog("agent left chat")}function F(){izilog("agent close chat"),localdata.clearVal("session")}function G(){timer.next("agent-replying",5e3,function(){utils.find(".izi-chat-typing").hide()}),userInterface.scrollChatArea(function(){utils.find(".izi-chat-typing").show()})}function H(){req.loadMessages(localdata.session._id,function(b,c){return b?a(b):void(userInterface.displayMessages(c,!0),userInterface.scrollChatArea(null,!0))})}function I(a,b){var c=localdata.config.enums.FormFieldType,d=!1,e={},f="";return a.forEach(function(a){var g=b+" #form_data-"+a.key,h=utils.find(g+" .izi-content",!0),i=utils.find(g+" .izi-error",!0),j=h.val().trim();if(a.field_type==c.UserEmail&&(f=j,j&&!utils.isValidEmail(j)))return userInterface.displayFormError(g,"chat.email.invalid"),d=!0;if(a.field_type==c.UserName){if(j&&!/^[\w0-9\- ÀÁÂÃÈÉÊÌÍÒÓÔÕÙÚĂĐĨŨƠàáâãèéêìíòóôõùúăđĩũơƯĂẠẢẤẦẨẪẬẮẰẲẴẶẸẺẼẾỀỂưăạảấầẩẫậắằẳẵặẹẻẽếềểỄỆỈỊỌỎỐỒỔỖỘỚỜỞỠỢỤỦỨỪễệỉịọỏốồổỗộớờởỡợụủứừỬỮỰỲỴÝỶỸửữựỳỵỷỹý]+$/gi.test(j))return userInterface.displayFormError(g,"chat.name.invalid"),d=!0}if(a.is_required&&!j){var k=localdata.trans.errors["chat.field.required"]||"";return userInterface.displayFormError(g,k.replace("{{field_name}}",a.title),!1),d=!0}userInterface.displayFormError(g),e["field-"+a.key]=j}),{is_error:d,data:e}}function J(){var a=localdata.config.routing,b=a.default_group,c=(utils.find("#routing_data-route .izi-content",!0).val()||"").toLowerCase();return utils.isValidObjectId(c)&&(b=c),b}var K=this;this.login=function(a,b){return localdata.user?b(null,localdata.user):void req.checkLogin(function(c,d){return!a||d?(d&&(req.setAuthToken(d.authToken),localdata.val("user",d)),b(c,d)):void req.login(a,function(a,c){return c&&(req.setAuthToken(c.authToken),localdata.val("user",c)),b(a,c)})})},this.addAnonymousAccount=function(a,b){var c={autogen:a};if(!a&&localdata.config.form.pre_chat.enable){var d=localdata.config.form.fields.filter(function(a){return a.enable}),e=I(d,".izi-pre-chat");if(e.is_error)return b(!0);c=e.data}c.host=localdata.parentLocation.host.replace(/^www\.|:[0-9]+$/gi,""),req.checkLogin(function(a,d){return a?b(a):d?(__connector.send("event:login",{success:!0}),req.setAuthToken(d.authToken),localdata.val("user",d),b()):void req.addAnonymousAccount(c,function(a,c){return a?(userInterface.displayFormError(null,a.single),b(a)):void(__connector.send("event:login",{success:!0}),req.setAuthToken(c.authToken),localdata.val("user",c),b())})})},this.initChat=function(){localdata.parentLocation.host.replace(/^www\.|:[0-9]+$/gi,"");req.trackUserUrl(function(a){req.setAuthToken(a.authToken)}),b()},this.execCommands=function(a){var b=localdata.config.form.connector.trusted_host;switch(izilog("Going to exec",a.topic),a.topic){case"check-status":return window.parent.postMessage("{\"topic\":\"initialized\"}",b),void __connector.send("event:initialized",{success:!0},b);case"data:authToken":return void __connector.send(a.topic,localdata.localSetting(tokenHeader()),b);case"popup:open":case"popup-open":return void userInterface.runMaximize();case"data:user-detail":case"fill-info":return void localdata.val("autoFillData",a.data);}}};function _Request(){function a(){var a=localdata.GeoIP||{IP:"-",city:"-",country:"-"};return{ip_address:a.IP,location:a.city+"/"+a.country,url:localdata.parentLocation.href,host:localdata.parentLocation.host.replace(/^www\.|:[0-9]+$/gi,"")}}this.setAuthToken=function(a){a?localdata.localSetting(tokenHeader(),a):(console.log("assign invalid authToken"),console.trace("authToken"))},this.getGeoIP=function(a){return a()},this.getWidgetVersion=function(a){utils.ajax("/api/chat/requester/settings/version","get",null,function(b){return b.errors?a(b.errors):a(null,b)})},this.getChatSession=function(b,c){var d=a();for(var e in d)b[e]=d[e];utils.ajax("/api/chat/requester/sessions","post",b,function(a){return a=window.toObject(a),window.isEmptyObject(a)?c(!0,null):a.errors?c(a.errors):c(null,a)})},this.trackUserUrl=function(a){var b={url:localdata.parentLocation.href,title:localdata.parentDocument.title,referrer_url:localdata.parentDocument.referrer};utils.ajax("/api/chat/requester/users/location","post",b,a)},this.getTranslation=function(a,b){var c=a?a.profile.language:"en";if(window.translation)return b(null,{translation:window.translation[c]||window.translation.default});utils.ajax("/api/chat/requester/translation"+utils.objectToQuery({lng:c}),"get",null,function(a){return a=window.toObject(a),a.errors?b(a.errors):b(null,a)})},this.getSetting=function(a){var b={enums:!0,host:localdata.parentLocation.host.replace(/^www\.|:[0-9]+$/gi,"")};utils.ajax("/api/chat/requester/settings"+utils.objectToQuery(b),"get",null,function(b){return b=window.toObject(b),b.errors?a(b.errors):a(null,b)})},this.checkLogin=function(a){utils.ajax("/api/chat/requester/me","get",null,function(b){return b=window.toObject(b),window.isEmptyObject(b)?a(null,null):b.errors?a(b.errors):a(null,b)})},this.login=function(a,b){utils.ajax("/api/auth/signin","post",a,function(a){return a=window.toObject(a),a.errors?b(a.errors):void b(null,a)})},this.currentAgentOnline=function(a){utils.ajax("/api/chat/requester/users/online/count","get",null,function(b){return b=window.toObject(b),b.errors?a(b.errors):void a(null,b)})},this.loadRecentSession=function(a,b){utils.ajax("/api/chat/requester/sessions/"+a+"/recent","get",null,function(a){return a=window.toObject(a),a.errors?b(a.errors):void b(null,a)})},this.loadMessages=function(a,b){utils.ajax("/api/chat/requester/sessions/"+a+"/messages","get",null,function(a){return a=window.toObject(a),a.errors?b(a.errors):void b(null,a)})},this.addMessage=function(a,b,c){var d=new FormData;d.append("file",b),utils.ajax("/api/chat/requester/sessions/"+a+"/messages","post",d,function(a){return a=window.toObject(a),a.errors?c(a.errors):c(null,a)})},this.rateChat=function(a,b,c){utils.ajax("/api/chat/requester/sessions/"+a+"/rating","put",b,function(a){return a=window.toObject(a),a.errors?c(a.errors):void c(null,a)})},this.markAllRead=function(a,b){utils.ajax("/api/chat/requester/sessions/"+a+"/counting/mark-all-read","put",null,function(a){return a=window.toObject(a),a.errors?b(a.errors):b(null,a)})},this.addAnonymousAccount=function(b,c){var d=a();for(var e in d)b[e]=d[e];utils.ajax("/api/chat/requester/anonymous","post",b,function(a){return a.errors?c(a.errors):void c(null,a)})},this.loadTriggers=function(a){utils.ajax("/api/chat/requester/settings/triggers","get",null,function(b){return b.errors?a(b.errors):void a(null,b)})}}function _Sound(){var a={new_message:new Audio(window.__iziconfig.get("clientAssets")+"sounds/receiving-message.mp3")};this.onMessage=function(){if(!1!==localdata.localSetting("sound-received"))try{a.new_message.play().catch(a=>{izilog(a)})}catch(a){izilog(a)}}}function _Interface(){function a(a){var b=localdata.config.enums.FormFieldType;return a.sort(function(c,a){return c.position-a.position}).map(function(a){var c={REQUIRED:a.is_required},d={FIELD_NAME:a.title,ID:"form_data-"+a.key,DEFAULT_VALUE:(localdata.autoFillData||{})[a.key]||""};if(a.field_type==b.Dropdown){var e=a.values.map(function(a){return{params:{VALUE:a.key,TEXT:a.title}}});d.OPTIONS=template.fillArrayTemplate("field_dropdown_option",e)}var f="field_input";return a.field_type==b.Dropdown?f="field_dropdown":a.field_type==b.TextArea&&(f="field_textarea"),template.fillTemplate(f,d,c)})}function b(a){var a=a||"",b=utils.getUrls(a);return a=a.replace(/\n/g,"<br>"),a}function c(a,b,c){if(c=c||{},localdata["last_msg_user"+(c.session_id||"")]==(a.user||{})._id)return b;localdata.val("last_msg_user"+(c.session_id||""),(a.user||{})._id);var d={AVATAR_URL:"/api/chat/users/"+(a.user||{})._id+"/profile/avatar",CHILD_MESSAGE:b},e={IS_MINE:a.is_mine};return template.fillTemplate("parent_message",d,e)}function d(a,d){d=d||{};var e=localdata.config.widget.content,f=localdata.config.enums.MsgType,g=localdata.config.enums.DateFormat,h=localdata.config.profile,i=moment(a.add_time).utcOffset(60*e.time_zone.value),j=24==e.time_format?"HH:mm":"hh:mm A",k=(g[e.date_format]||"DD/MM/YYYY")+" "+j;a.is_mine=(a.user||{})._id==localdata.user._id;var l={SESSION_ID:a.session_id,USER_NAME:a.is_mine?localdata.trans.me:h.display_name||(a.user||{}).name||a.user_name||"",TIME_TITLE:i.format(k),TIME:i.format(j),OWNER_ID:a.ed_user_id,HOST:localdata.config.pre_host.replace("{{subdomain}}","static")},m={NOT_FILE:a.type!=f.File||!a.attachment,IS_FILE:a.type==f.File&&a.attachment},n="child_message";if(a.type==f.File&&a.attachment){var o=a.attachment.originalname.split("."),p=(o[o.length-1]||"").trim(),q=!1;l.FILE_NAME=a.attachment.filename,q=q||(m.IS_IMAGE=-1!=["gif","jpeg","jpg","png"].indexOf(p)),q=q||(m.IS_WORD=-1!=["doc","docx","odt"].indexOf(p)),q=q||(m.IS_EXEL=-1!=["xls","xlsx","ods"].indexOf(p)),q=q||(m.IS_TEXT=-1!=["txt"].indexOf(p)),q=q||(m.IS_PDF=-1!=["pdf"].indexOf(p)),m.IS_DEFAULT=!q}else{if(l.CONTENT=b(a.content),a.type==f.TriggerNotif)return n="notify_message",delete l.USER_NAME,delete l.TIME,localdata.clearVal("last_msg_user"+(d.session_id||"")),template.fillTemplate(n,l);if(a.type==f.TriggerInfo)return n="notify_message",localdata.clearVal("last_msg_user"+(d.session_id||"")),template.fillTemplate(n,l)}return c(a,template.fillTemplate(n,l,m),d)}function f(){utils.find(".izi-chat-root").removeClass("mde-actived"),localdata.val("isMaximize",!0),userInterface.maximize(!0),"left-chat"!=localdata.widgetStatus&&h.setWidgetTitle()}function g(a){parent.postMessage(JSON.stringify({topic:"style",style:a}),"*"),wc<wcsDevice&&utils.find(".mde-chat-online").addClass("mdeDevice")}var h=this;this.applyConfig=function(a){var b=a.form,c=a.widget,d=a.setting,e=a.profile;utils.find(".izi-chat-config-color").style("background-color",c.window.color),utils.find(".izi-chat-status").html(c.window.status||"").title(c.window.status||""),utils.find(".izi-chat-company_name").html(e.name||d.company_name),e.avatar&&utils.find(".izi-chat-logo").imgSrc("/api/chat/settings/site-profile/"+e._id+"/avatar?"+e.__v),template.translate("body"),h.applyParentConfig(a),h.setWidgetTitle(),izilog("Config applied",a)},this.localConfig=function(){var a=localdata.localSetting("sound-received");utils.find(".izi-config_sound-received").checked(a)},this.applyParentConfig=function(a){var b=a.widget.window,c=a.enums.WidgetPosition,d=a.enums.WidgetSize,e=a.enums.WidgetSizeDetail;localdata.val("config-widget-size",e[b.size]);var f="right",h=e[b.size];if(b.position.value==c.BottomLeft&&(f="left"),wc<wcsDevice){var i={bottom:0,width:"80px",height:"58px",display:""};i[f]="0"}else{var i={bottom:0,width:localdata.isMaximize?h.width:"200px",height:"35px",display:"","border-top-left-radius":"5px"};i[f]=b.position.offset+"px"}g(i)},this.initPreChat=function(b){localdata.val("widgetStatus","pre-chat");var c=localdata.config.routing,d=localdata.config.form.fields,e=a(d.filter(function(a){return a.enable}));if(c.enable){var f=c.groups.map(function(a){return{params:{TEXT:a.name,VALUE:a.group_id?a.group_id:"-"}}}),g=template.fillTemplate("field_dropdown",{OPTIONS:template.fillArrayTemplate("field_dropdown_option",f),FIELD_NAME:c.title,ID:"routing_data-route"});e.push(g)}localdata.preAskMessage&&e.push(template.fillTemplate("field_textarea",{ID:"izi-pre-ask-msg",FIELD_NAME:localdata.trans.message_title})),userInterface.maximize(!0),h.setWidgetTitle(),utils.find(".izi-visitor-form-desc").html(localdata.config.form.pre_chat.greeting),utils.find(".izi-btn-start_chat").html(localdata.config.widget.button.start_chat),utils.find(".izi-main-container").addClass("mde-register-offline"),utils.find(".izi-offline-chat,.izi-online-chat").hide(),utils.find(".izi-pre-chat").show(),utils.find(".izi-ul-visitor-info").html(e.join("")),utils.find(".izi-ul-visitor-info").keyUp(function(a){13!=a.keyCode||a.shiftKey||b()}),utils.find("#izi-pre-ask-msg .izi-content").html(localdata.preAskMessage),utils.find("#izi-pre-ask-msg .izi-content").change(function(a,b){localdata.val("preAskMessage",b.value)})},this.initInChat=function(){localdata.val("widgetStatus","in-chat"),utils.find(".izi-main-container").removeClass("mde-register-offline"),utils.find(".izi-pre-chat,.izi-offline-chat").hide(),utils.find(".izi-online-chat").show(),userInterface.maximize(!1!==localdata.localSetting("isMaximize")),h.setWidgetTitle(),localdata.session.is_create_new&&utils.find(".izi-chat-textarea").focus()},this.initLeftMessageChat=function(){localdata.val("widgetStatus","left-chat"),utils.find(".izi-visitor-left-message-desc").html(localdata.config.form.offline.greeting.sent),h.setWidgetTitle(localdata.config.widget.button.header.offline.sent),utils.find(".izi-pre-chat,.izi-offline-chat").hide(),utils.find(".izi-left-message-chat").show()},this.initAgentInterface=function(){utils.find(".izi-chat-visitor").hide(),utils.find(".izi-chat-agent").show();var a="/api/chat/users/"+localdata.user._id+"/profile/avatar";utils.find(".izi-agent-avatar").imgSrc(a),utils.find(".izi-chat-agent-desc").html(localdata.trans.agent_in_visitor_desc)},this.initBanner=function(a){var b=localdata.config.enums.BadgeType,c=localdata.config.widget,d=c.badge||{};if(!d.enable)return h.displayBanner(!1),void h.displayMainChat(!0);switch(a(),d.badge_type!=b.CustomImage&&utils.find(".izi-banner-text").html(d.text||""),d.badge_type!=b.TextOnly&&utils.find(".izi-banner-image").imgSrc("/api/chat/settings/widget/"+c._id+"/badge-image?"+c.__v),d.badge_type){case b.ImageLeft:break;case b.ImageRight:utils.find(".izi-banner-root").addClass("mde-rowReverse");break;case b.TextOnly:utils.find(".izi-banner-root").addClass("mde-onlyText");break;case b.CustomImage:utils.find(".izi-banner-root").addClass("mde-onlyImage");}utils.find(".izi-title-text").html(d.title||""),h.displayBanner(!0),h.displayMainChat(!1),g({height:"236px",width:"300px"})},this.setWidgetTitle=function(a){if(a)return utils.find(".izi-chat-title").html(a);var b=localdata.widgetStatus,a=localdata.config.widget.button.header.online;localdata.isMaximize||"in-chat"==b?utils.find(".izi-chat-title").html(a.max):utils.find(".izi-chat-title").html(a.min)},this.maximize=function(a){var b=utils.find(".izi-chat-root");localdata.val("isMaximize",a),localdata.localSetting("isMaximize",a),a?(h.scrollChatArea(void 0,!0),wc<wcsDevice?g({height:"100vh","max-height":"-webkit-fill-available",width:"100%",top:"0px",bottom:"initial"}):g({height:localdata.val("config-widget-size").height,width:"300px"}),b.removeClass("mde-actived")):(wc<wcsDevice?g({height:"58px",width:"80px",bottom:"0px",top:"initial"}):g({height:"35px",width:"200px"}),b.addClass("mde-actived"))},this.displayMessages=function(a,b){b&&utils.find(".izi-chat-conversation").empty(),a.forEach(function(a){a.user&&localdata.last_msg_user==a.user._id?utils.find(".izi-chat-conversation .izi-last-parent-message",!0).append(d(a)):(utils.find(".izi-chat-conversation .izi-last-parent-message",!0).removeClass("izi-last-parent-message"),utils.find(".izi-chat-conversation").append(d(a)))})},this.displayRecentMessages=function(a,b){utils.find(".izi-chat-root-recent").prepend(template.fillTemplate("parent_recent_message",{SESSION_ID:b}));var c=".izi-chat-recent-"+b+" .izi-chat-conversation";a.forEach(function(a){a.user&&localdata["last_msg_user"+b]==a.user._id?utils.find(c+" .izi-last-parent-message",!0).append(d(a,{session_id:b})):(utils.find(c+" .izi-last-parent-message",!0).removeClass("izi-last-parent-message"),utils.find(c).append(d(a,{session_id:b})))})},this.displayBtnLoadmoreMessages=function(a){a?utils.find(".izi-btn-more-messages").show():utils.find(".izi-btn-more-messages").hide()},this.displayBanner=function(a){a?utils.find(".izi-banner-root").show():utils.find(".izi-banner-root").hide()},this.displayMainChat=function(a){a?utils.find(".izi-chat-root").show():utils.find(".izi-chat-root").hide()},this.scrollChatArea=function(a,b){utils.find(".izi-main-container").scrollToBottom(a,b)},this.offlineMessage=function(){var a=utils.find(".izi-pre-chat #izi-offline-chat-message .izi-content"),b=utils.find(".izi-pre-chat #izi-offline-chat-message .izi-error");if(val=a.val(),!val){var c=localdata.config.form.offline.msg_title,d=localdata.trans.errors["chat.field.required"]||"";b.html(d.replace("{{field_name}}",c)).show()}else b.hide();return val},this.unreadCounter=function(a,b){var c=utils.find(".izi-chat-unread"),d=localdata.val("total-unread",a,b)||0;c.html(d),d&&c.show()},this.clearMsgInput=function(){utils.find(".izi-chat-textarea").val("")},this.disableMsgInput=function(a){utils.find(".izi-chat-textarea").disable(!1!==a)},this.clearUnread=function(){localdata.val("total-unread",0),utils.find(".izi-chat-unread").hide()},this.btnStartChatClick=function(a){utils.find(".izi-btn-start_chat").click(a,!0)},this.btnShowMenuClick=function(){utils.find(".izi-btn-show-menu").click(function(a,b){utils.dom(utils.closestParent(b,".izi-div-menu-parent")).addClass("mde-actived")}),utils.find(".izi-btn-show-menu-mask").click(function(a,b){utils.dom(utils.closestParent(b,".izi-div-menu-parent")).removeClass("mde-actived")})},this.runMaximize=function(){},this.btnMaximizeClick=function(a){this.runMaximize=function(){a(f)},utils.find(".izi-btn-maximize").click(this.runMaximize)},this.btnMinimizeClick=function(){utils.find(".izi-btn-minimize").click(function(){localdata.localSetting("isMaximize",!1),utils.find(".izi-chat-root").addClass("mde-actived"),userInterface.maximize(!1),"left-chat"!=localdata.widgetStatus&&h.setWidgetTitle()})},this.btnHeaderBannerClick=function(){utils.find(".izi-btn-banner-min").click(function(){g({height:"35px",width:"200px"}),utils.find(".izi-banner-root").addClass("mde-minimize")}),utils.find(".izi-btn-banner-max").click(function(){g({height:"236px",width:"300px"}),utils.find(".izi-banner-root").removeClass("mde-minimize")})},this.btnContentBannerClick=function(a){utils.find(".izi-btn-banner-content").click(function(){a(f)})},this.btnBannerSendMessage=function(a){utils.find(".izi-banner-message").keyDown(function(b){13==b.keyCode&&(localdata.val("preAskMessage",utils.find(".izi-banner-message").val()),a(f))}),utils.find(".izi-btn-banner-send-message").click(function(){localdata.val("preAskMessage",utils.find(".izi-banner-message").val()),a(f)})},this.btnEmojiClick=function(){var a=utils.find(".izi-chat-emoji-div");utils.find(".izi-btn-emoji").click(function(){a.ancestor(".izi-chat-div-root").addClass("mde-actived"),a.hasClass("izi-unload")&&(a.removeClass("izi-unload"),a.html(emoji.list("tpl_emoji_item")))},!0),a.clickOn(".emoji",function(b,c){a.ancestor(".izi-chat-div-root").removeClass("mde-actived");var d=utils.dom(c).data("emoji");d&&utils.find(".izi-chat-textarea").val(d,!0)},!0)},this.btnMoreMessagesClick=function(a){utils.find(".izi-btn-more-messages").click(a)},this.btnRatingChooseClick=function(){function a(a,b){utils.find(".izi-chat-rating").data("rating",a).find(".mde-actived",!0).removeClass("mde-actived"),b.addClass("mde-actived")}var b=localdata.config.enums.Rating;utils.find(".izi-btn-rating-choose-good").click(function(c,d){a(b.Good,utils.dom(d))}),utils.find(".izi-btn-rating-choose-bad").click(function(c,d){a(b.Bad,utils.dom(d))})},this.btnLeavePopupClick=function(){utils.find(".izi-btn-leave-popup").click(function(a,b){utils.dom(utils.closestParent(b,".izi-div-menu-parent")).removeClass("mde-actived"),h.showLeavePopup()})},this.btnLeaveClick=function(a){var b=localdata.config.enums.Rating,c=localdata.trans.errors["chat.rating.invalid"];utils.find(".izi-btn-leave").click(function(){var c=utils.find(".izi-rating-comment").val(),d=utils.find(".izi-chat-rating").data("rating"),e=b[d]?{comment:c,value:d}:null;a(e,function(){utils.find(".izi-popup-leave-chat").removeClass("mde-actived")})})},this.btnSoundReceivedChange=function(){utils.find(".izi-config_sound-received").change(function(a,b){localdata.localSetting("sound-received",b.checked)})},this.mainContainerClick=function(a){utils.find(".izi-chat-root").click(a)},this.onSelectedAttach=function(a){utils.find(".izi-chat-inp-attach").change(function(b,c){0<c.files.length&&a(c.files[0])})},this.pressEnterMsgInput=function(a){utils.find(".izi-chat-textarea").keyDown(function(b,c){13!=b.keyCode||b.shiftKey||(a(c.value.trim()),b.preventDefault())},!0)},this.clickBtnSendMessage=function(a){utils.find(".izi-send-chat-btn").click(function(b){a(utils.find(".izi-chat-textarea").val().trim()),b.preventDefault()})},this.pressAnyMsgInput=function(a){utils.find(".izi-chat-textarea").keyUp(function(b,c){a(0<c.value.length)},!0)},this.alreadyInitOnlineChat=function(a){return a?utils.find(".izi-chat-root").removeClass("izi-not-ready-online-chat"):!utils.find(".izi-chat-root").hasClass("izi-not-ready-online-chat")},this.alreadyInitPreChat=function(a){return a?utils.find(".izi-chat-root").removeClass("izi-not-ready-pre-chat"):!utils.find(".izi-chat-root").hasClass("izi-not-ready-pre-chat")},this.displayErrorNotify=function(a){localdata.clearVal("last_msg_user"),utils.find(".izi-chat-conversation").append(template.fillTemplate("error_message",{CONTENT:a}))},this.displayFormError=function(a,b,c){var d=utils.find((a||".izi-general")+" .izi-error",!0);if(b){var e=!1===c?b:localdata.trans.errors[b]||b;d.html(e||"").show()}else d.hide()},this.showLeavePopup=function(){utils.find(".izi-popup-leave-chat").addClass("mde-actived"),utils.find(".izi-chat-rating").data("rating",localdata.config.enums.Rating.Good).find(".mde-actived",!0).removeClass("mde-actived"),utils.find(".izi-rating-comment").val(""),utils.find(".izi-btn-rating-choose-good").addClass("mde-actived")},this.setComponentColor=function(){var a=localdata.config.widget.window.color,b=localdata.config.widget.badge,c=document.createElement("style");c.innerHTML="            .izi-component-color {                background-color:"+a+" !important;            }            .izi-component-text-color {                color:"+a+" !important;            }            .izi-component-border-color {                border-color:"+a+" !important;            }            .izi-banner-component-color {                background-color:"+(b.bg_color||a)+" !important;            }            .izi-banner-component-text-color {                color:"+(b.text_color||a)+" !important;            }        ",document.body.appendChild(c)}}